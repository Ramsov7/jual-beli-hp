<script>
let db = JSON.parse(localStorage.getItem("db_unit")) || [];

function simpanDB(){
  localStorage.setItem("db_unit", JSON.stringify(db));
}

function fmtIDR(x){
  if(!x) return "Rp0";
  return "Rp" + x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function tambahUnit(){
  let unit = {
    id: Date.now(),
    merk: document.getElementById("merk").value,
    tipe: document.getElementById("tipe").value,
    imei: document.getElementById("imei").value,
    hargaBeli: parseInt(document.getElementById("hargaBeli").value) || 0,
    ongkosPerbaikan: [],
    biayaPerbaikan: 0,
    hargaJual: 0,       // âœ… field baru
    status: "BELUM TERJUAL",
    tanggal: Date.now()
  };
  db.push(unit);
  simpanDB();
  render();
}

function tambahOngkos(id){
  const nama = prompt("Jenis perbaikan?");
  const biaya = parseInt(prompt("Biaya perbaikan?")) || 0;
  if(!nama) return;
  const unit = db.find(u=>u.id==id);
  if(unit){
    unit.ongkosPerbaikan.push({nama, biaya});
    unit.biayaPerbaikan += biaya;
    simpanDB();
    bukaDetail(id);
    render();
  }
}

function updateHargaJual(id, val){
  const item = db.find(u => u.id == id);
  if(item){
    item.hargaJual = parseInt(val) || 0;
    if(item.hargaJual > 0){
      item.status = "TERJUAL";
    }
    simpanDB();
    render();
    bukaDetail(id); // refresh popup
  }
}

function bukaDetail(id){
  const data = db.find(u=>u.id==id);
  if(!data) return;
  const totalModal = (data.hargaBeli||0) + (data.biayaPerbaikan||0);
  const labaBersih = (data.hargaJual||0) - totalModal;

  document.getElementById("popup").innerHTML = `
  <div class="card">
    <h3>Detail Unit</h3>
    <div class="field"><b>Merk:</b> ${data.merk}</div>
    <div class="field"><b>Tipe:</b> ${data.tipe}</div>
    <div class="field"><b>IMEI:</b> ${data.imei}</div>
    <div class="field"><b>Harga Beli:</b> ${fmtIDR(data.hargaBeli)}</div>
    <div class="field"><b>Ongkos Perbaikan:</b> 
      ${data.ongkosPerbaikan.map(o=>`<li>${o.nama} - ${fmtIDR(o.biaya)}</li>`).join("")}
      <br><b>Total:</b> ${fmtIDR(data.biayaPerbaikan)}
      <button onclick="tambahOngkos(${data.id})">+ Tambah</button>
    </div>
    <div class="field">
      <label>Harga Jual</label>
      <input type="number" value="${data.hargaJual || ''}" 
             onchange="updateHargaJual(${data.id}, this.value)">
    </div>
    <div class="field row">
      <div><b>Total Modal:</b><br>${fmtIDR(totalModal)}</div>
      <div><b>Laba Bersih:</b><br>${fmtIDR(labaBersih)}</div>
    </div>
    <div class="field"><b>Status:</b> ${data.status}</div>
    <button onclick="tutupDetail()">Tutup</button>
  </div>
  `;
  document.getElementById("popup").style.display="block";
}

function tutupDetail(){
  document.getElementById("popup").style.display="none";
}

function render(){
  let html = db.map(u=>`
    <div class="card" onclick="bukaDetail(${u.id})">
      <b>${u.merk} ${u.tipe}</b><br>
      Beli: ${fmtIDR(u.hargaBeli)} | 
      Jual: ${fmtIDR(u.hargaJual)}<br>
      Status: ${u.status}
    </div>
  `).join("");
  document.getElementById("list").innerHTML = html;
}

render();
</script>