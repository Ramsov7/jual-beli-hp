<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>HP Inventory</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    form { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    input, textarea, button { display: block; margin: 5px 0; padding: 6px; }
    ul { list-style: none; padding: 0; }
    li { margin: 8px 0; padding: 10px; border: 1px solid #ccc; }
    .status { font-weight: bold; }
    .popup { display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; }
    .dynamic-field { display:flex; gap:5px; margin:5px 0; }
    .dynamic-field input { flex:1; }
  </style>
</head>
<body>
  <h2>Form Beli HP</h2>
  <form id="formBeli">
    <label>Tanggal Masuk: <input type="date" id="tanggalMasuk" required></label>
    <label>Lokasi Transaksi Penjual: <input type="text" id="lokasiPenjual" required></label>
    <label>Tipe & Varian: <input type="text" id="tipeVarian" required></label>
    <label>Harga Beli: <input type="number" id="hargaBeli" required></label>
    <div id="pengecekanPenjualContainer">
      <label>Pengecekan dengan Penjual:</label>
    </div>
    <button type="button" onclick="addField('pengecekanPenjualContainer','pengecekanPenjual')">+ Tambah Cek</button>
    <button type="submit">Simpan</button>
  </form>

  <h2>Daftar Unit</h2>
  <ul id="unitList"></ul>

  <div id="detailPopup" class="popup"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA-taZOYNdqrPqfaA3ObSAC2hJ7UzMTaQs",
      authDomain: "ramsov-hp-inventory.firebaseapp.com",
      projectId: "ramsov-hp-inventory",
      storageBucket: "ramsov-hp-inventory.firebasestorage.app",
      messagingSenderId: "384818720368",
      appId: "1:384818720368:web:ae61ec9869da0c83b9ceb5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const unitRef = collection(db, "units");

    // ====== Helper add dynamic field ======
    window.addField = function(containerId, name) {
      const container = document.getElementById(containerId);
      const index = container.querySelectorAll("input").length + 1;
      const div = document.createElement("div");
      div.className = "dynamic-field";
      div.innerHTML = `<input type="text" name="${name}" placeholder="Cek#${index}"><button type="button" onclick="this.parentNode.remove()">x</button>`;
      container.appendChild(div);
    }

    function getArrayFromInputs(name) {
      return Array.from(document.getElementsByName(name)).map(i=>i.value).filter(v=>v);
    }

    // ====== Submit Form Beli ======
    document.getElementById("formBeli").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const editId = e.target.getAttribute("data-edit-id");
      const tanggalMasuk = document.getElementById("tanggalMasuk").value;
      const lokasiPenjual = document.getElementById("lokasiPenjual").value;
      const tipeVarian = document.getElementById("tipeVarian").value;
      const hargaBeli = +document.getElementById("hargaBeli").value;
      const pengecekanDenganPenjual = getArrayFromInputs("pengecekanPenjual");

      if(editId) {
        await updateDoc(doc(db,"units",editId), {
          tanggalMasuk, lokasiTransaksiPenjual: lokasiPenjual,
          tipeVarian, hargaBeli, pengecekanDenganPenjual
        });
        e.target.removeAttribute("data-edit-id");
      } else {
        await addDoc(unitRef, {
          tanggalMasuk, lokasiTransaksiPenjual: lokasiPenjual,
          tipeVarian, hargaBeli, pengecekanDenganPenjual,
          status: "Belum Selesai"
        });
      }
      e.target.reset();
      document.getElementById("pengecekanPenjualContainer").innerHTML="<label>Pengecekan dengan Penjual:</label>";
    });

    // ====== Load Units ======
    function loadUnits(){
      onSnapshot(unitRef, (snapshot)=>{
        const list = document.getElementById("unitList");
        list.innerHTML="";
        snapshot.forEach(docSnap=>{
          const data=docSnap.data();
          const li=document.createElement("li");
          li.innerHTML=`
            <div><b>${data.tipeVarian}</b> - <span class="status">${data.status}</span></div>
            <button onclick="showDetail('${docSnap.id}')">Detail</button>
            <button onclick="editUnit('${docSnap.id}')">Edit</button>
            <button onclick="hapusUnit('${docSnap.id}')">Hapus</button>
          `;
          if(data.status==="Belum Selesai"){
            li.innerHTML += `
              <button onclick="showPerbaikanForm('${docSnap.id}')">Perbaiki</button>
              <button onclick="jadikanBangkai('${docSnap.id}')">Jadikan Bangkai</button>
            `;
          }
          list.appendChild(li);
        });
      });
    }
    loadUnits();

    // ====== Detail Popup ======
    window.showDetail = async (id)=>{
      const snap = await getDocs(unitRef);
      let data; snap.forEach(s=>{ if(s.id===id) data=s.data(); });
      const popup=document.getElementById("detailPopup");
      popup.innerHTML=`<h3>Detail Unit</h3>
        <p>Tipe & Varian: ${data.tipeVarian}</p>
        <p>Tanggal Masuk: ${data.tanggalMasuk}</p>
        <p>Lokasi Penjual: ${data.lokasiTransaksiPenjual}</p>
        <p>Harga Beli: ${data.hargaBeli}</p>
        <p>Pengecekan: ${(data.pengecekanDenganPenjual||[]).join(", ")}</p>
        <button onclick="document.getElementById('detailPopup').style.display='none'">Tutup</button>`;
      popup.style.display="block";
    }

    // ====== Hapus ======
    window.hapusUnit = async (id)=>{
      if(confirm("Yakin hapus unit ini?")){
        await deleteDoc(doc(db,"units",id));
      }
    }

    // ====== Edit ======
    window.editUnit = async (id)=>{
      const snap = await getDocs(unitRef);
      let data; snap.forEach(s=>{ if(s.id===id) data=s.data(); });
      document.getElementById("tanggalMasuk").value=data.tanggalMasuk;
      document.getElementById("lokasiPenjual").value=data.lokasiTransaksiPenjual;
      document.getElementById("tipeVarian").value=data.tipeVarian;
      document.getElementById("hargaBeli").value=data.hargaBeli;
      document.getElementById("pengecekanPenjualContainer").innerHTML="<label>Pengecekan dengan Penjual:</label>";
      (data.pengecekanDenganPenjual||[]).forEach((val,i)=>{
        const div=document.createElement("div");
        div.className="dynamic-field";
        div.innerHTML=`<input type="text" name="pengecekanPenjual" value="${val}"><button type="button" onclick="this.parentNode.remove()">x</button>`;
        document.getElementById("pengecekanPenjualContainer").appendChild(div);
      });
      document.getElementById("formBeli").setAttribute("data-edit-id", id);
    }

    // ====== Jadikan Bangkai ======
    window.jadikanBangkai = async (id)=>{
      await updateDoc(doc(db,"units",id), { status:"Selesai", hasil:"Bangkai" });
    }

    // ====== Perbaiki (placeholder) ======
    window.showPerbaikanForm = (id)=>{
      alert("Form perbaikan untuk ID "+id+" belum dibuat di versi ini.");
    }
  </script>
</body>
</html>