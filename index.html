<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>HP Inventory Dashboard</title>
  <style>
    body { margin:0; padding:0; font-family:Arial, sans-serif; display:flex; flex-direction:column; height:100vh; }
    header { padding:15px; background:#1976d2; color:#fff; text-align:center; }
    main { flex:1; display:flex; flex-direction:column; padding:20px; overflow:hidden; }
    button { padding:7px 12px; border:none; background:#1976d2; color:#fff; border-radius:4px; cursor:pointer; margin:2px; }
    button:hover { background:#0d47a1; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border:1px solid #ccc; text-align:center; }
    th { background:#f2f2f2; }
    #pagination { margin-top:10px; text-align:center; }
    #pagination button { margin:0 3px; background:#e0e0e0; color:#000; }
    #pagination button.active { background:#1976d2; color:#fff; }
    .popup { display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; width:400px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
    .dynamic-field { display:flex; gap:5px; margin:5px 0; }
    .dynamic-field input { flex:1; }
  </style>
</head>
<body>
  <header><h2>Dashboard HP Inventory</h2></header>

  <main>
    <button onclick="openForm()">+ Tambah Unit</button>
    <div style="flex:1; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Nama Unit</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="unitTable"></tbody>
      </table>
    </div>
    <div id="pagination"></div>
  </main>

  <!-- Popup Form Tambah/Edit -->
  <div id="formPopup" class="popup"></div>
  <!-- Popup Detail -->
  <div id="detailPopup" class="popup"></div>
  <!-- Popup Perbaikan -->
  <div id="repairPopup" class="popup"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA-taZOYNdqrPqfaA3ObSAC2hJ7UzMTaQs",
      authDomain: "ramsov-hp-inventory.firebaseapp.com",
      projectId: "ramsov-hp-inventory",
      storageBucket: "ramsov-hp-inventory.firebasestorage.app",
      messagingSenderId: "384818720368",
      appId: "1:384818720368:web:ae61ec9869da0c83b9ceb5"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const unitRef = collection(db,"units");

    let allUnits=[]; let currentPage=1; const perPage=5;

    // Tambah field dinamis
    window.addField=function(containerId,name){
      const container=document.getElementById(containerId);
      const index=container.querySelectorAll("input").length+1;
      const div=document.createElement("div");
      div.className="dynamic-field";
      div.innerHTML=`<input type="text" name="${name}" placeholder="Cek#${index}">
                     <button type="button" onclick="this.parentNode.remove()">x</button>`;
      container.appendChild(div);
    }
    function getArrayFromInputs(name){
      return Array.from(document.getElementsByName(name)).map(i=>i.value).filter(v=>v);
    }

    // Tambah Unit
    window.openForm=()=>{
      const formPopup=document.getElementById("formPopup");
      formPopup.innerHTML=`
        <h3>Tambah Unit</h3>
        <form id="formBeli">
          <label>Tanggal Masuk: <input type="date" id="tanggalMasuk" required></label>
          <label>Lokasi Penjual: <input type="text" id="lokasiPenjual" required></label>
          <label>Tipe & Varian: <input type="text" id="tipeVarian" required></label>
          <label>Harga Beli: <input type="number" id="hargaBeli" required></label>
          <div id="pengecekanPenjualContainer">
            <label>Pengecekan dengan Penjual:</label>
          </div>
          <button type="button" onclick="addField('pengecekanPenjualContainer','pengecekanPenjual')">+ Tambah Cek</button>
          <button type="submit">Simpan</button>
          <button type="button" onclick="closeForm()">Batal</button>
        </form>`;
      formPopup.style.display="block";
      document.getElementById("formBeli").addEventListener("submit",async(e)=>{
        e.preventDefault();
        const data={
          tanggalMasuk:document.getElementById("tanggalMasuk").value,
          lokasiTransaksiPenjual:document.getElementById("lokasiPenjual").value,
          tipeVarian:document.getElementById("tipeVarian").value,
          hargaBeli:+document.getElementById("hargaBeli").value,
          pengecekanDenganPenjual:getArrayFromInputs("pengecekanPenjual"),
          status:"Belum Selesai",
          perbaikan:[]
        };
        await addDoc(unitRef,data);
        closeForm();
      });
    }
    window.closeForm=()=>document.getElementById("formPopup").style.display="none";

    // Load realtime
    function loadUnits(){
      onSnapshot(unitRef,(snapshot)=>{
        allUnits=[];
        snapshot.forEach(docSnap=>allUnits.push({id:docSnap.id,...docSnap.data()}));
        renderTable();
      });
    }
    loadUnits();

    function renderTable(){
      const table=document.getElementById("unitTable");
      table.innerHTML="";
      const start=(currentPage-1)*perPage;
      const end=start+perPage;
      const pageItems=allUnits.slice(start,end);
      pageItems.forEach((u,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${start+i+1}</td>
          <td>${u.tipeVarian}</td>
          <td>${u.status}</td>
          <td>
            <button onclick="showDetail('${u.id}')">Detail</button>
            <button onclick="openRepair('${u.id}')">Perbaiki</button>
            <button onclick="jadikanBangkai('${u.id}')">Jadikan Bangkai</button>
            <button onclick="hapusUnit('${u.id}')">Hapus</button>
          </td>`;
        table.appendChild(tr);
      });
      renderPagination();
    }

    function renderPagination(){
      const pageCount=Math.ceil(allUnits.length/perPage);
      const pag=document.getElementById("pagination");
      pag.innerHTML="";
      for(let i=1;i<=pageCount;i++){
        const btn=document.createElement("button");
        btn.textContent=i;
        if(i===currentPage) btn.classList.add("active");
        btn.onclick=()=>{currentPage=i; renderTable();}
        pag.appendChild(btn);
      }
    }

    // Hapus
    window.hapusUnit=async(id)=>{
      if(confirm("Yakin hapus unit ini?")) await deleteDoc(doc(db,"units",id));
    }

    // Detail
    window.showDetail=(id)=>{
      const u=allUnits.find(x=>x.id===id);
      const popup=document.getElementById("detailPopup");
      popup.innerHTML=`
        <h3>Detail Unit</h3>
        <p>Tipe & Varian: ${u.tipeVarian}</p>
        <p>Tanggal Masuk: ${u.tanggalMasuk}</p>
        <p>Lokasi Penjual: ${u.lokasiTransaksiPenjual}</p>
        <p>Harga Beli: ${u.hargaBeli}</p>
        <p>Pengecekan: ${(u.pengecekanDenganPenjual||[]).join(", ")}</p>
        <p>Status: ${u.status}</p>
        <p>Perbaikan: ${(u.perbaikan||[]).join(", ")}</p>
        <button onclick="document.getElementById('detailPopup').style.display='none'">Tutup</button>`;
      popup.style.display="block";
    }

    // Perbaikan
    window.openRepair=(id)=>{
      const popup=document.getElementById("repairPopup");
      popup.innerHTML=`
        <h3>Perbaikan Unit</h3>
        <form id="formRepair">
          <div id="perbaikanContainer"></div>
          <button type="button" onclick="addField('perbaikanContainer','perbaikan')">+ Tambah Cek</button>
          <button type="submit">Simpan</button>
          <button type="button" onclick="document.getElementById('repairPopup').style.display='none'">Batal</button>
        </form>`;
      popup.style.display="block";
      document.getElementById("formRepair").addEventListener("submit",async(e)=>{
        e.preventDefault();
        const perbaikan=getArrayFromInputs("perbaikan");
        await updateDoc(doc(db,"units",id),{perbaikan});
        document.getElementById("repairPopup").style.display="none";
      });
    }

    // Jadikan Bangkai
    window.jadikanBangkai=async(id)=>{
      if(confirm("Yakin jadikan bangkai?")){
        await updateDoc(doc(db,"units",id),{status:"Bangkai"});
      }
    }
  </script>
</body>
</html>